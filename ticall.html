<html>
	<head>
	<title>Nrml</title>
	<link href="http://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet">
 	<script src="http://ajax.googleapis.com/ajax/libs/angularjs/1.3.10/angular.min.js"></script>
  	 
  	  <style type="text/css">
table {
    border-collapse: collapse;
}
table, td, th {
    border: 1px solid white;
}
.table > tbody > tr > td{
	padding: 0px;
}
.checkboxFour {
  	width: 100%;
  	height: 100%;
  	background: #ddd;
  	border-radius: 100%;
  	position: relative;
 	
}
.checkboxFour label {
  	display: block;
  	width: 100%;
  	height: 100%;
  	-webkit-transition: all .2s ease;
 	-moz-transition: all .2s ease;
 	-o-transition: all .2s ease;
    -ms-transition: all .2s ease;
  	transition: all .2s ease;
  	cursor: pointer;
  	position: absolute;
  	top: 0px;
  	left: 0px;
  	z-index: 1;
  	background: #333;
    
}
.checkboxFour input[type=checkbox]  {
  	margin: 17px 5px 0;
}
.checkboxFour input[type=checkbox]:checked + .p1 {
	background: #26ca28;
}
.checkboxFour input[type=checkbox]:checked + .p2 {
	background: red;
}
.checkboxFour input[type=checkbox]:checked + .remain {
	background: #afafaf;
}
.headline {
  height: 35px;
  padding-top: 5px
}



  	  </style>
	 
<html>
	<head>
	  <title>Nrml</title>
	  <link href="bootstrap.min.css" rel="stylesheet">
	  <script src="angular.min.js"></script>
	  <link href="style.css" rel="stylesheet">
	  <script src="app.js"></script>
	</head>
	<body ng-app="tictactoe" ng-controller="MainCtrl">
		<div class="row">
			<div class="col-md-3 headline" >
				<input type="button" ng-click="restartgame()" value="Restart" />
				<span ng-show="p1queue.length==0"><input type="checkbox" ng-model="withyogy" ng-click="playwith()" />&nbsp;Play With Yogy's Mind.</span>
				<span ng-show="p1queue.length!=0 && withyogy">Playing With Yogy...</span>
				<span ng-show="p1queue.length!=0 && !withyogy">Playing With Friend...</span>
				<span ng-show="p1queue.length!=0">{{playerturnmsg}}</span>
			</div>
			<div class="col-md-2" style="">
				{{result}}
			</div>
		</div>
		<div class="row" >
			<div class="col-md-3 table-responsive">
				<div class="row">
					<div class="col-md-12">
						<table class="table">
							<tr ng-repeat="boardrows in board">
								<td ng-repeat="boardcols in boardrows">
									<div class="checkboxFour"> 
										<input id="{{boardcols}}" type="checkbox" ng-click="playeraction(boardcols)" ng-model="boardcol[boardcols]" ng-disabled="boardcol[boardcols]" />
										<label ng-class="{
										'p1':p1queue.indexOf(boardcols)!=-1,
										'p2':p2queue.indexOf(boardcols)!=-1,
										'remain':remaincells.indexOf(boardcols)!=-1
										}"  
										for="{{boardcols}}"></label>
									</div>
								</td>
							</tr>
						</table>
					</div>
				</div>	
			</div>
		</div>
	</body>
</html>

<script type="text/javascript">
var app = angular.module('tictactoe', []);
app.controller('MainCtrl',['$scope','$timeout',MainCtrl]);
function MainCtrl($scope,$timeout) {
	var players = ['Player 1','Player 2'];
	var winmsgs = {
  		twoplayers:{
  			[players[0]]:players[0]+' wins.',
  			[players[1]]:players[1]+' wins.'
  		},
  		withyogy:{'player':'You win.','yogy':'You lose.'}
	};var wmf = '';
	var turnmsgs = {
		twoplayers:{
			[players[0]]:players[0]+' turn.',
			[players[1]]:players[1]+' turn.'
  		},
  		withyogy:{'player':'Your turn.','yogy':'Yogy\'s turn.'}
  		};
  	$scope.withyogy = true;
	$scope.playwith = function(){
		if($scope.withyogy){
			wmf = 'withyogy';
			$scope.playerturnmsg = turnmsgs[wmf]['player'];
		} else {
			wmf = 'twoplayers';
			$scope.playerturnmsg = turnmsgs[wmf][players[0]];
		}
	}
	$scope.restartgame = function() {
		$scope.playwith();
		$scope.playerturn = players[0];
  		$scope.p1queue = [];
  		$scope.p2queue = [];
  		$scope.result = '';
		$scope.boardcol = {};
		$scope.board = [];
		$scope.remaincells = [];
		for(var i=1;i<=15;i++){ var temp = [];
			for(var j=1;j<=15;j++){
				var cell = 'r'+i+'c'+j;
				temp.push(cell);
				$scope.remaincells.push(cell);
			}
			$scope.board.push(temp);
		}
	}
	$scope.restartgame();
	$scope.playeraction = function(boardcols) {
		$scope.remaincells.splice($scope.remaincells.indexOf(boardcols),1);   
		if($scope.withyogy)
	    	withyogyputer(boardcols);
		else
			twoplayers(boardcols);
	     
	}
	var withyogyputer = function(boardcols) {
		$scope.p1queue.push(boardcols);
		$scope.playerturnmsg = turnmsgs[wmf]['yogy'];
      	if(!resultcreater($scope.p1queue,'player')) {
      		$timeout(function() {
	      		if(randcell = getrandcell()){
			      	$scope.p2queue.push(randcell);
			      	$scope.boardcol[randcell] = true;
			      	$scope.remaincells.splice($scope.remaincells.indexOf(randcell),1);
			      	if(!resultcreater($scope.p2queue,'yogy'))
			      		$scope.playerturnmsg = turnmsgs[wmf]['player'];
			    }
      		}, 500);
      	}

	}
	var twoplayers = function(boardcols){
		if($scope.playerturn == players[0]){
	    	$scope.playerturn = players[1];
	      	$scope.playerturnmsg = turnmsgs[wmf][players[1]];      
	      	$scope.p1queue.push(boardcols);
	      	resultcreater($scope.p1queue,players[0]);
	      	
	    } else {
	      	$scope.playerturn = players[0];
	      	$scope.playerturnmsg = turnmsgs[wmf][players[0]];
	      	$scope.p2queue.push(boardcols);
	      	resultcreater($scope.p2queue,players[1]);
	    }
    }
    var resultcreater = function(playerqueue,playerturns) {
    	if(getcon_win_p(playerqueue,5)){
   			$scope.result = winmsgs[wmf][playerturns];
   			$scope.playerturnmsg = '';
   			disableremaincell();
   			return true;
   		}

    }
    var getwincon = function(cell) {
    	var wincon = [];
		var nearst = getnearst(cell);
		var secondnearst = getsecondnearst(cell);
		wincon.push([cell,nearst[0][0],nearst[0][1],secondnearst[0][0],secondnearst[0][1]]);
		wincon.push([cell,nearst[1][0],nearst[1][1],secondnearst[1][0],secondnearst[1][1]]);
		wincon.push([cell,nearst[2][0],nearst[2][1],secondnearst[2][0],secondnearst[2][1]]);
		wincon.push([cell,nearst[3][0],nearst[3][1],secondnearst[3][0],secondnearst[3][1]]);
		return wincon;
    }
    var getrc = function(cell){
    	var rc = cell.split('r')[1].split('c');
		for(var i =0;i<rc.length;i++){
			rc[i] = Number(rc[i]);
		}
		return rc;
    }
	var getnearst = function(cell){
		var nearst = []; var rc = getrc(cell);
		nearst.push(['r'+(rc[0]-1)+'c'+(rc[1]),'r'+(rc[0]+1)+'c'+(rc[1])]);
		nearst.push(['r'+(rc[0])+'c'+(rc[1]-1),'r'+(rc[0])+'c'+(rc[1]+1)]);
		nearst.push(['r'+(rc[0]-1)+'c'+(rc[1]-1),'r'+(rc[0]+1)+'c'+(rc[1]+1)]);
		nearst.push(['r'+(rc[0]-1)+'c'+(rc[1]+1),'r'+(rc[0]+1)+'c'+(rc[1]-1)]);
		return nearst;
	}
	var getsecondnearst = function(cell){
		var secondnearst = []; var rc = getrc(cell);
		secondnearst.push(['r'+(rc[0]-2)+'c'+(rc[1]),'r'+(rc[0]+2)+'c'+(rc[1])]);
		secondnearst.push(['r'+(rc[0])+'c'+(rc[1]-2),'r'+(rc[0])+'c'+(rc[1]+2)]);
		secondnearst.push(['r'+(rc[0]-2)+'c'+(rc[1]-2),'r'+(rc[0]+2)+'c'+(rc[1]+2)]);
		secondnearst.push(['r'+(rc[0]-2)+'c'+(rc[1]+2),'r'+(rc[0]+2)+'c'+(rc[1]-2)]);
		return secondnearst;
	}
    var disableremaincell = function() {
	  for($i=0;$i<$scope.remaincells.length;$i++){
	    $scope.boardcol[$scope.remaincells[$i]] = true;
	  }
	}
	var getallinone = function(accarray){
		var temp = [];
		for(var i=0;i<accarray.length;i++){
			for(var j=0;j<accarray[i].length;j++){
				temp.push(accarray[i][j]);
			}
		}
		return temp;
	}
	var removeused = function(remainarr,quearr){
		var temp = [];
		for(var i=0;i<quearr.length;i++){
			if(remainarr.indexOf(quearr[i])!=-1)
				temp.push(quearr[i]);
		}
		return temp;
	}
	var randelement = function(arr){
		return arr[Math.floor(Math.random() * arr.length)];
	}
	var getcon_win_p = function(playerqueue,wps){
		var queuelen = playerqueue.length;
	   	for(var i=0;i<queuelen;i++){ 
			var wincon = getwincon(playerqueue[i]); 
			for(var j=0;j<wincon.length;j++){ var matched = [];
			   for(var k=0;k<queuelen;k++){ 
		        	for(var l=0;l<wincon[j].length;l++){ 
			          	if(playerqueue[k]==wincon[j][l]){
			          		matched.push(wincon[j][l]);
			            	wincon[j].splice(wincon[j].indexOf(playerqueue[k]),1);
			            }
			       	}
		    	} 
		    	if(matched.length==wps){
		    		if(wps==5){
		    			return true;
		    		} else { 
		    			var remainarr = removeused($scope.remaincells,wincon[j]);
		    			if(remainarr.length==(5-wps)){ var perfectarr = [];
		    				for(var m=0;m<matched.length;m++){
		    					var nearst = getallinone(getnearst(matched[m]));
		    					for(var n=0;n<remainarr.length;n++){
		    						if(nearst.indexOf(remainarr[n])!=-1)
		    							perfectarr.push(remainarr[n]);
		    					}
		    				}
		    				if(wps==4&perfectarr.length==1)	
			    				return perfectarr[0];
			    			else if(perfectarr.length==2)
			    				return randelement(perfectarr);
		    			}
		    		}	
		    	}
			}
		}
	}
	var getrandcell = function(){
		var randcell = '';
		if(randcell=getrand_p7())
			return randcell;
		else if(randcell=getrand_p6())
			return randcell;
		else if(randcell=getrand_p5())
			return randcell;
		else if(randcell=getrand_p4())
			return randcell;
		else if(randcell=getrand_p3())
			return randcell;
		else if(randcell=getrand_p2())
			return randcell;
		else if(randcell=getrand_p1())
			return randcell;
		else if(randcell=getrand_p0())
			return randcell;
	}

	var getrand_p7 = function(){ //get perfect closer for queue with 4 element self
		var randcell ='';
		if(randcell = getcon_win_p($scope.p2queue,4)){ 
			return randcell; 
		}	
	}
	var getrand_p6 = function(){ //get perfect closer for queue with 4 element opponent
		var randcell ='';
		if(randcell = getcon_win_p($scope.p1queue,4)){ 
			return randcell; 
		}	
	}
	var getrand_p5 = function(){ //get perfect closer for queue with 3 element self
		var randcell ='';
		if(randcell = getcon_win_p($scope.p2queue,3)){ 
			return randcell; 
		}	
	}
	var getrand_p4 = function(){ //get perfect closer for queue with 3 element opponent
		var randcell ='';
		if(randcell = getcon_win_p($scope.p1queue,3)){ 
			return randcell; 
		}	
	}
	var getrand_p3 = function(){ //get perfect closer for queue with 2 element self 
		var randcell ='';
		if(randcell = getcon_win_p($scope.p2queue,2)){ 
			return randcell; 
		}
	}
	var getrand_p2 = function(){ //get perfect closer for queue with 2 element opponent
		var randcell ='';
		if(randcell = getcon_win_p($scope.p1queue,2)){ 
			return randcell; 
		}	
	}
	var getrand_p1 = function(){ //get perfect closer for queue with 1 element self
		var randcell ='';
		if(randcell = getcon_win_p($scope.p2queue,1)){ 
			return randcell; 
		}
	}
	var getrand_p0 = function(){
		var temp = [];
		for(var i=5;i<=9;i++){ 
			for(var j=5;j<=9;j++){
				var cell = 'r'+i+'c'+j;
				temp.push(cell);
			}
		}
		var midrand = randelement(removeused($scope.remaincells,temp));
		if(midrand){ 
			return midrand;
		}
		else 
			return randelement($scope.remaincells);
	}


}
</script>
